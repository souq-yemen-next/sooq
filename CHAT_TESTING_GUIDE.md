# ุฏููู ุงุฎุชุจุงุฑ ูุธุงู ุงููุญุงุฏุซุงุช

## ุงูุฅุนุฏุงุฏ ุงููุทููุจ

ูุจู ุงูุจุฏุก ุจุงูุงุฎุชุจุงุฑุ ุชุฃูุฏ ูู:
1. ูุดุฑ Firebase rules ุงูุฌุฏูุฏุฉ (ูู ููู `firestore.rules`)
2. ุชุดุบูู ุงููุดุฑูุน ูุญููุงู: `npm run dev`
3. ูุฌูุฏ ุญุณุงุจูู ูุณุชุฎุฏููู ูุฎุชูููู ููุงุฎุชุจุงุฑ

## ุงูุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑูุฉ

### 1๏ธโฃ ุงุฎุชุจุงุฑ ุฅูุดุงุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ

**ุงูุฎุทูุงุช:**
1. ุณุฌู ุฏุฎูู ุจุงููุณุชุฎุฏู ุงูุฃูู
2. ุงุฐูุจ ุฅูู ุฃู ุตูุญุฉ ุฅุนูุงู (ูุซูุงู `/listing/abc123`)
3. ุงุถุบุท ุนูู ุฒุฑ "๐ฌ ูุญุงุฏุซุฉ"
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ูุฌุจ ุฃู ุชููุชุญ ุตูุญุฉ `/chat/abc123__uidA__uidB`
   - ูุง ูุธูุฑ ุฎุทุฃ "chatId ููููุฏ"
   - ุชุธูุฑ ุฑุณุงูุฉ "ุงุจุฏุฃ ุฃูู ุฑุณุงูุฉ ๐"

**ุงูุชุญูู:**
```
โ ุงูุฑุงุจุท ูุญุชูู ุนูู chatId ุจุตูุบุฉ: listingId__minUid__maxUid
โ ุงูุตูุญุฉ ุชูุญููู ุจุฏูู ุฃุฎุทุงุก
โ ูุง ุชูุฌุฏ ุฑุณุงุฆู console errors
```

---

### 2๏ธโฃ ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฑุณุงูุฉ

**ุงูุฎุทูุงุช:**
1. ูู ุตูุญุฉ ุงููุญุงุฏุซุฉ ุงูููุชูุญุฉ
2. ุงูุชุจ ุฑุณุงูุฉ ูู ุญูู ุงูุฅุฏุฎุงู
3. ุงุถุบุท "ุฅุฑุณุงู"
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุงูุฑุณุงูุฉ ุชุธูุฑ ููุฑุงู ูู ุงูุดุงุช
   - ุงูุฑุณุงูุฉ ุนูู ุงููููู (ูุฃููุง ููู)
   - ูุธูุฑ "ุฃูุช" ูุงุณู ุงููุฑุณู
   - ูุธูุฑ ุงูููุช

**ุงูุชุญูู ูู Firestore Console:**
```javascript
// ูู chats/{chatId}/messages/{messageId}
{
  from: "uidA",          // UID ุงูุฎุงุต ุจู
  text: "ุฑุณุงูุชู",
  createdAt: Timestamp   // ููุช ุงูุฅุฑุณุงู
}

// ูู chats/{chatId}
{
  lastMessageText: "ุฑุณุงูุชู",
  lastMessageBy: "uidA",
  updatedAt: Timestamp,
  unread: {
    uidA: 0,      // ุชู ุงูุชุตููุฑ ูู
    uidB: 1       // ุฒูุงุฏุฉ ููุทุฑู ุงูุขุฎุฑ
  }
}
```

---

### 3๏ธโฃ ุงุฎุชุจุงุฑ ููุน ุงูุชูุฑุงุฑ

**ุงูุฎุทูุงุช:**
1. ุงุฑุฌุน ุฅูู ููุณ ุตูุญุฉ ุงูุฅุนูุงู
2. ุงุถุบุท "๐ฌ ูุญุงุฏุซุฉ" ูุฑุฉ ุฃุฎุฑู
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ููุชุญ **ููุณ** ุงูุฑุงุจุท `/chat/abc123__uidA__uidB`
   - ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ ููุฌูุฏุฉ
   - ูุง ูุชู ุฅูุดุงุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ

**ุงูุชุญูู ูู Firestore:**
```
โ ุนุฏุฏ ูุซุงุฆู chats ูู ูุฒุฏุงุฏ
โ ููุณ chatId
โ ุงูุฑุณุงุฆู ููุฌูุฏุฉ
```

---

### 4๏ธโฃ ุงุฎุชุจุงุฑ ุงูุทุฑู ุงูุขุฎุฑ (ุงููุณุชุฎุฏู ุงูุซุงูู)

**ุงูุฎุทูุงุช:**
1. ุณุฌู ุฎุฑูุฌ ูู ุงููุณุชุฎุฏู ุงูุฃูู
2. ุณุฌู ุฏุฎูู ุจุงููุณุชุฎุฏู ุงูุซุงูู
3. ุงุฐูุจ ุฅูู `/my-chats`
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุชุธูุฑ ุงููุญุงุฏุซุฉ ูู ุงููุงุฆูุฉ
   - ูุธูุฑ ุนููุงู ุงูุฅุนูุงู
   - ูุธูุฑ badge "1" ููุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ
   - ุขุฎุฑ ุฑุณุงูุฉ ุชุธูุฑ ูู ุงููุนุงููุฉ

5. ุงุถุบุท ุนูู ุงููุญุงุฏุซุฉ
6. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุชููุชุญ ููุณ ุงููุญุงุฏุซุฉ
   - ุงูุฑุณุงุฆู ุนูู ุงููุณุงุฑ (ูุฃููุง ูู ุงูุทุฑู ุงูุขุฎุฑ)
   - ูุธูุฑ ุงุณู ุงููุฑุณู ุงูุขุฎุฑ

7. ุฃุฑุณู ุฑุฏ
8. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุงูุฑุณุงูุฉ ุชุธูุฑ ุนูู ุงููููู
   - ูุธูุฑ "ุฃูุช" ูุงุณู ุงููุฑุณู

---

### 5๏ธโฃ ุงุฎุชุจุงุฑ chatId ุนูู ุงูุฌูุงู

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ Chrome DevTools
2. ุงุถุบุท F12
3. ุงุถุบุท ุนูู ุฃููููุฉ ุงูุฌูุงู (Toggle device toolbar)
4. ุงุฎุชุฑ ุฌูุงุฒ ุฌูุงู (ูุซูุงู iPhone 12)
5. ุงูุชุญ ุฑุงุจุท ูุญุงุฏุซุฉ: `/chat/abc123__uidA__uidB`
6. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุงูุตูุญุฉ ุชูุญููู ุจุดูู ุตุญูุญ
   - ูุง ูุธูุฑ "chatId ููููุฏ"
   - ุงูุชุตููู ููุงุณุจ ููุฌูุงู
   - ุงูู input ุซุงุจุช ูู ุงูุฃุณูู

---

### 6๏ธโฃ ุงุฎุชุจุงุฑ Firestore Rules

**ุงุฎุชุจุงุฑ ูู Firebase Console:**

1. ุงุฐูุจ ุฅูู Firestore Database โ Rules
2. ุงุถุบุท ุนูู "Rules playground"

**Test 1: ูุฑุงุกุฉ ูุญุงุฏุซุฉ ุฃูุช ูุดุงุฑู ูููุง**
```
Operation: get
Location: /chats/abc123__uidA__uidB
Authenticated: Yes
Auth UID: uidA
Custom Claims: {}

Expected: โ Allowed (ูุฃูู ูู participants)
```

**Test 2: ูุฑุงุกุฉ ูุญุงุฏุซุฉ ูุณุช ูุดุงุฑูุงู ูููุง**
```
Operation: get
Location: /chats/abc123__uidX__uidY
Authenticated: Yes
Auth UID: uidA

Expected: โ Denied (ูุณุช ูู participants)
```

**Test 3: ุฅุฑุณุงู ุฑุณุงูุฉ**
```
Operation: create
Location: /chats/abc123__uidA__uidB/messages/msg123
Authenticated: Yes
Auth UID: uidA
Data:
{
  "from": "uidA",
  "text": "test",
  "createdAt": {"serverTimestamp": true}
}

Expected: โ Allowed
```

**Test 4: ุฅุฑุณุงู ุฑุณุงูุฉ ุจู from ูุฎุชูู**
```
Operation: create
Location: /chats/abc123__uidA__uidB/messages/msg123
Authenticated: Yes
Auth UID: uidA
Data:
{
  "from": "uidB",  // โ ูุฎุชูู ุนู Auth UID
  "text": "test",
  "createdAt": {"serverTimestamp": true}
}

Expected: โ Denied (from ูุง ูุณุงูู request.auth.uid)
```

---

### 7๏ธโฃ ุงุฎุชุจุงุฑ ุงูุชูุงูู ูุน ุงูุฑุณุงุฆู ุงููุฏููุฉ

**ุฅุฐุง ูุงู ูุฏูู ุฑุณุงุฆู ูุฏููุฉ ุจุตูุบุฉ `senderUid`:**

1. ุงูุชุญ ูุญุงุฏุซุฉ ุชุญุชูู ุฑุณุงุฆู ูุฏููุฉ
2. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุงูุฑุณุงุฆู ุงููุฏููุฉ ุชุธูุฑ ุจุดูู ุตุญูุญ
   - ุงุณู ุงููุฑุณู ูุธูุฑ (ูู `senderName` ุฃู fallback ุฅูู "ูุณุชุฎุฏู")
3. ุฃุฑุณู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุงูุฑุณุงูุฉ ุงูุฌุฏูุฏุฉ ุชูุญูุธ ุจุตูุบุฉ `from` ููุท
   - ุชุนูู ุจุฏูู ูุดุงูู

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: "chatId ููููุฏ"
**ุงูุญู:**
- ุชุฃูุฏ ูู ุฃู ุงูููุฏ ูุณุชุฎุฏู `useParams()` ูููุณ `params` prop
- ุชุญูู ูู ุงูู URL ูู ุงูู browser
- ุชุฃูุฏ ูู ุฃู chatId ููุฌูุฏ ูู ุงูุฑุงุจุท

### ุงููุดููุฉ: "ูุดู ุฅุฑุณุงู ุงูุฑุณุงูุฉ"
**ุงูุญู:**
1. ุชุญูู ูู Firebase Console โ Firestore โ Rules
2. ุชุฃูุฏ ูู ูุดุฑ ุงูููุงุนุฏ ุงูุฌุฏูุฏุฉ
3. ุชุญูู ูู Console ูู ุงููุชุตูุญ ููุฃุฎุทุงุก
4. ุชุฃูุฏ ูู ุฃู ุงูุตูุบุฉ ุชุทุงุจู:
   ```javascript
   {
     from: uid,
     text: string,
     createdAt: serverTimestamp()
   }
   ```

### ุงููุดููุฉ: ุชูุฑุงุฑ ุงููุญุงุฏุซุงุช
**ุงูุญู:**
- ุชุฃูุฏ ูู ุงุณุชุฎุฏุงู `makeChatId` ูู `lib/chatId.js`
- ุชุฃูุฏ ูู ุงุณุชุฏุนุงุก `ensureChatDoc` ูุจู router.push
- ุงุญุฐู ุงููุญุงุฏุซุงุช ุงูููุฑุฑุฉ ูุฏููุงู ูู Firestore

---

## โ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ

ูุจู ุงุนุชุจุงุฑ ุงูุงุฎุชุจุงุฑ ููุชููุงู:

- [ ] ุฅูุดุงุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ ูุนูู
- [ ] ุฅุฑุณุงู ุฑุณุงูุฉ ูุนูู ุจุฏูู ุฃุฎุทุงุก
- [ ] chatId ุซุงุจุช (ูุง ุชูุฑุงุฑ)
- [ ] ูุงุฆูุฉ ุงููุญุงุฏุซุงุช ุชุธูุฑ ุจุดูู ุตุญูุญ
- [ ] ุนุฏุงุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ูุนูู
- [ ] ุงูุทุฑู ุงูุขุฎุฑ ูุฑู ุงููุญุงุฏุซุฉ ูุงูุฑุณุงุฆู
- [ ] ุงูุชุตููู ููุงุณุจ ููุฌูุงู
- [ ] Firebase rules ุขููุฉ
- [ ] ูุง ุชูุฌุฏ console errors

---

## ๐ ุงููุชููุน ูู Firestore

### ุจููุฉ Chat Document:
```javascript
chats/{chatId} {
  participants: ["uidA", "uidB"],
  listingId: "abc123",
  listingTitle: "ุนููุงู ุงูุฅุนูุงู",
  createdAt: Timestamp,
  updatedAt: Timestamp,
  lastMessageText: "ุขุฎุฑ ุฑุณุงูุฉ",
  lastMessageBy: "uidA",
  unread: {
    uidA: 0,
    uidB: 3
  }
}
```

### ุจููุฉ Message Document:
```javascript
chats/{chatId}/messages/{messageId} {
  from: "uidA",
  text: "ูุญุชูู ุงูุฑุณุงูุฉ",
  createdAt: Timestamp
}
```

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ุจุนุฏ ุฅููุงู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุจูุฌุงุญ:
- โ ุงููุธุงู ูุนูู ุจุดูู ูุงูู
- โ ูุง ุชูุฌุฏ ูุดุงูู ูู chatId
- โ ูุง ุชูุฑุงุฑ ูู ุงููุญุงุฏุซุงุช
- โ ุฅุฑุณุงู ุงูุฑุณุงุฆู ูุนูู ุจุดูู ููุซูู
- โ ุงูุชุตููู ููุชุงุฒ ููุฌูุงู
- โ ุงูุฃูุงู ูุญูู

**ุชูุงูููุง! ๐ ูุธุงู ุงููุญุงุฏุซุงุช ูุนูู ุจููุงุกุฉ ุงูุขู.**
